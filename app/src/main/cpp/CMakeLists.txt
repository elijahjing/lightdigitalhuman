# For more information about using CMake with Android Studio, read the
# documentation: https://d.android.com/studio/projects/add-native-code.html.
# For more examples on how to use CMake, see https://github.com/android/ndk-samples.

# Sets the minimum CMake version required for this project.
cmake_minimum_required(VERSION 3.22.1)

# Declares the project name. The project name can be accessed via ${ PROJECT_NAME},
# Since this is the top level CMakeLists.txt, the project name is also accessible
# with ${CMAKE_PROJECT_NAME} (both CMake variables are in-sync within the top level
# build script scope).
project("lightdigitalhuman")

# Creates and names a library, sets it as either STATIC
# or SHARED, and provides the relative paths to its source code.
# You can define multiple libraries, and CMake builds them for you.
# Gradle automatically packages shared libraries with your APK.
#
# In this top level CMakeLists.txt, ${CMAKE_PROJECT_NAME} is used to define
# the target library name; in the sub-module's CMakeLists.txt, ${PROJECT_NAME}
# is preferred for the same purpose.
#
# In order to load a library into your app from Java/Kotlin, you must call
# System.loadLibrary() and pass the name of the library defined here;
# for GameActivity/NativeActivity derived applications, the same library name must be
# used in the AndroidManifest.xml file.
add_library(${CMAKE_PROJECT_NAME} SHARED
        # List C/C++ source files with relative paths to this CMakeLists.txt.
        third_party/tinygltf/tiny_gltf.cc
        NativeInterface.cpp
        gltfdata/GltfObject.cpp
        utils/utils.cpp
        gltfdata/UserCamera.cpp
        gltfdata/UniformStruct.cpp
        gltfdata/ShaderCache.cpp
        gltfdata/math_utils.cpp
        gltfdata/JsonLoad.cpp
        gltfdata/ImageMimeTypes.cpp
        gltfdata/GltfOpenGLContext.cpp
        engine/Engine.cpp
        gltfdata/GltfUtils.cpp
        gltfdata/GltfTexture.cpp
        gltfdata/GltfState.cpp
        gltfdata/GltfSkin.cpp
        gltfdata/GltfShader.cpp
        gltfdata/GltfScene.cpp
        gltfdata/GltfSampler.cpp
        gltfdata/GltfRenderer.cpp
        gltfdata/ibl/HDRImageLoader.cpp
        gltfdata/GltfPrimitive.cpp
        gltfdata/GltfNode.cpp
        gltfdata/GltfMesh.cpp
        gltfdata/GltfMaterial.cpp
        gltfdata/GltfLight.cpp
        gltfdata/GltfInterpolator.cpp
        gltfdata/GltfImage.cpp
        gltfdata/GltfEnvironment.cpp
        gltfdata/ibl_sampler.cpp
        gltfdata/GltfConverter.cpp
        gltfdata/GltfCamera.cpp
        gltfdata/GltfBufferView.cpp
        gltfdata/GltfBuffer.cpp
        gltfdata/GltfAsset.cpp
        gltfdata/GltfAnimationSampler.cpp
        gltfdata/GltfAnimationChannel.cpp
        gltfdata/GltfAnimation.cpp
        gltfdata/GltfAccessor.cpp
        gltfdata/Gltf.cpp
        gltfdata/EnvironmentRenderer.cpp
        gltfdata/converter/MaterialConverter.cpp
        gltfdata/converter/GltfLoader.cpp
        #        native-lib.cpp
)

set(KTX_ROOT_DIR ${CMAKE_CURRENT_SOURCE_DIR}/third_party/ktx)

# æ£€æŸ¥KTXåº“æ˜¯å¦å­˜åœ¨
if (NOT EXISTS ${KTX_ROOT_DIR}/include/ktx.h)
    message(FATAL_ERROR "KTXåº“æœªæ‰¾åˆ°! è¯·å…ˆä¸‹è½½KTXåº“åˆ° ${KTX_ROOT_DIR}")
endif ()

# åˆ›å»ºå¯¼å…¥çš„KTXåº“
add_library(ktx_imported STATIC IMPORTED)
set(KTX_LIB_PATH ${KTX_ROOT_DIR}/lib/libktx.so)
# æ£€æŸ¥åº“æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if (NOT EXISTS ${KTX_LIB_PATH})
    message(FATAL_ERROR "KTXåº“æ–‡ä»¶æœªæ‰¾åˆ°: ${KTX_LIB_PATH}")
endif ()

# é…ç½®å¯¼å…¥åº“
set_target_properties(ktx_imported PROPERTIES
        IMPORTED_LOCATION ${KTX_LIB_PATH}
        INTERFACE_INCLUDE_DIRECTORIES ${KTX_ROOT_DIR}/include
)

message(STATUS "KTXåº“é…ç½®æˆåŠŸ: ${ANDROID_ABI}")
target_include_directories(lightdigitalhuman PRIVATE
        ${KTX_ROOT_DIR}/include
)
# æŸ¥æ‰¾OpenGL ESåº“
find_library(
        glesv3-lib
        GLESv3
)

find_library(
        egl-lib
        EGL
)
# æ·»åŠ åŒ…å«ç›®å½•
include_directories(third_party/tinygltf)
include_directories(third_party/glm/glm)  # æ·»åŠ è¿™è¡Œ
include_directories(third_party/glm)  # GLMåº“

add_subdirectory(third_party/tinygltf)

# Specifies libraries CMake should link to your target library. You
# can link libraries from various origins, such as libraries defined in this
# build script, prebuilt third-party libraries, or Android system libraries.
target_link_libraries(${CMAKE_PROJECT_NAME}
        ktx_imported
        # List libraries link to the target library
        ${log-lib}
        ${glesv3-lib}      # æ·»åŠ è¿™è¡Œ
        ${egl-lib}         # æ·»åŠ è¿™è¡Œ
        android
        tinygltf
        log)


# åªåœ¨è¿™é‡Œå®šä¹‰STBå®ç°
target_compile_definitions(tinygltf PRIVATE
        TINYGLTF_IMPLEMENTATION
        STB_IMAGE_IMPLEMENTATION
        STB_IMAGE_WRITE_IMPLEMENTATION
        STB_IMAGE_RESIZE_IMPLEMENTATION
)
#
## å®Œæ•´çš„ Android æ¶æ„ä¼˜åŒ–é…ç½®

#
#add_definitions(-DGLM_FORCE_INTRINSICS)
#add_definitions(-DGLM_FORCE_ALIGNED)
#add_definitions(-DGLM_FORCE_SINGLE_ONLY)  # åªä½¿ç”¨ float
#add_definitions(-DGLM_FORCE_FAST_MATH)
#
#if (CMAKE_ANDROID_ARCH_ABI STREQUAL "arm64-v8a")
#    message(STATUS "ARM64 ä¼˜åŒ–é…ç½®")
#    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -march=armv8-a+simd")
#    # ARM64 çš„ NEON é»˜è®¤å¯ç”¨ï¼Œä¸éœ€è¦é¢å¤–å‚æ•°
#
#elseif (CMAKE_ANDROID_ARCH_ABI STREQUAL "armeabi-v7a")
#    message(STATUS "ARM32 ä¼˜åŒ–é…ç½®")
#    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -march=armv7-a -mfpu=neon")
#    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -mfloat-abi=softfp")
#
#elseif (CMAKE_ANDROID_ARCH_ABI STREQUAL "x86_64")
#    message(STATUS "x86_64 ä¼˜åŒ–é…ç½®")
#    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -msse4.1 -mavx")
#    add_definitions(-DGLM_FORCE_SIMD_AVX2)  # åªå¯¹ x86 å¯ç”¨ AVX
#
#elseif (CMAKE_ANDROID_ARCH_ABI STREQUAL "x86")
#    message(STATUS "x86 ä¼˜åŒ–é…ç½®")
#    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -msse4.1")
#
#endif ()
#
#
#set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -ffast-math")
#set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -funroll-loops")
#set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O3")
#
#message(STATUS "ğŸ”§ æœ€ç»ˆç¼–è¯‘å‚æ•°: ${CMAKE_CXX_FLAGS}")
